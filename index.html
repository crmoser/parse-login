<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Parse Prototype</title>
  <meta name="description" content="My Parse App">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.2.min.js"></script>
</head>

<body>

  <div class="container">
    <div class="username">
      <label>Username</label>
      <input type="text"></input>
    </div>
    <button class="fb-sign-in"></button>
    <div class="user-info"></div>
  </div>

  
  <div id="fb-root"></div>

  <script type="text/javascript">

	Parse.initialize("MhsTx95fClaI5CSB7pPqBoC2BPJvOwyIvRQMTCQS", "yZZMGCjCHlIryXe7cRFqkjrZFOTxf4j587H0gAzw");

  window.fbAsyncInit = function() {
		Parse.FacebookUtils.init({
			appId      : '642657672506723',
			status     : true,  
			cookie     : true,  
			xfbml      : true,
			version    : 'v2.2'
		});

    function userInfo() {
      var currentUser = Parse.User.current();
      if (currentUser) {
          $('.fb-sign-in').text("You're Signed In! Now Sign Out.").removeClass('enabled').addClass('disabled');
          $('.username').addClass('disabled');
          $('.user-info').show();
      } else {
          $('.fb-sign-in').text("Sign In With Facebook").removeClass('disabled').addClass('enabled');
          $('.username').removeClass('disabled');
          $('.username input').val('');
      }
    }
  
    function fbSignIn() {
      if ($('.username input').val()) {
        // Make a new Parse user, 'sign in' with FB, and set their info in the Parse.user object.
        var user = new Parse.User();
        Parse.FacebookUtils.logIn('email, user_location', {
    			success: function(user) {
              $('.fb-sign-in').text("You're Signed In! Now Sign Out.").removeClass('enabled').addClass('disabled');
              $('.username').addClass('disabled');
              FB.api('/me', function(response) {
                  var imgLink = "http://graph.facebook.com/"+response.id+"/picture",
                      username = $(".username input").val();

                  user.set("name", response.name);
                  user.set("username", username);
                  user.set("email", response.email);
                  user.set("location", response.location.name); 
                  user.set("profilepic", imgLink);
                  
                  $('.user-info').html(
                      '<img src=' + user.attributes.profilepic + '/>' + '<br />' +
                      'Name: ' + user.attributes.name + '<br />' +
                      'Username: ' + user.attributes.username + '<br />' +
                      'Email: ' + user.attributes.email + '<br />' +
                      'Location: ' + user.attributes.location
                  );

                  userInfo();

              });

          },
          error: function(user, error) {
            console.log("User cancelled the Facebook login or did not fully authorize.");
    			}
  	    });
      } else {
        alert('Make a username.');
      }
    }

    function fbSignOut() {
      Parse.User.logOut();
      $('.user-info').hide().html('');
      userInfo();
    }
    
    userInfo();
    
    //Event Handlers
    $(".fb-sign-in").click(function () {
      if ($(this).is('.enabled')) {
        fbSignIn();
      } else {
        fbSignOut();
      }
    });

  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "http://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  </script>

</body>

</html>
