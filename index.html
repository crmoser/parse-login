<!doctype html>
<head>
  <meta charset="utf-8">

  <title>Parse Prototype</title>
  <meta name="description" content="My Parse App">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.3.2.min.js"></script>
</head>

<body>
  <div id="loginform">
    <div id="facebook">
      <i class="fa fa-facebook"></i>
      <div id="connect">Connect with Facebook</div>
      <span id="signout" href="#">Sign out</span>
      <div id="userinfo"></div>
    </div>
      <div id="mainlogin">
        <div id="or">or</div>
        <h1>Log in with Parse</h1>
        <form action="#">
          <input id="username" type="text" placeholder="email" value="" required>
          <input id="password" type="password" placeholder="password" value="" required>
          <span id="logout" href="#">Sign out</span>
          <button type="submit"><i class="fa fa-arrow-right"></i></button>
        </form>
        <span id="note">Forgot your password?</span>
        <div id="resetform">
          <input type="text" placeholder="Enter your email address" required>
          <span id="passwordreset">Reset password</span>
        </div>
    </div>
  </div>

  
  <div id="fb-root"></div>

  <script type="text/javascript">

	Parse.initialize("MhsTx95fClaI5CSB7pPqBoC2BPJvOwyIvRQMTCQS", "yZZMGCjCHlIryXe7cRFqkjrZFOTxf4j587H0gAzw");

  window.fbAsyncInit = function() {
		Parse.FacebookUtils.init({
			appId      : '642657672506723',
			status     : true,  
			cookie     : true,  
			xfbml      : true,
			version    : 'v2.2'
		});

    function userInfo() {
      var user = Parse.User.current();

      if (user && user.attributes.authData != undefined) {
        var fbID = "/" + user.attributes.authData.facebook.id;
        FB.api(fbID, function(response) {
            user.set("name", response.name);
            user.set("username", response.first_name + '.' + response.last_name);
            user.set("email", response.email);
            user.set("location", response.location.name); 
            user.set("profilepic", "http://graph.facebook.com/" + response.id + "/picture");
            user.save(null, {
              success: function(user) {
                console.log("User Saved!");
              },
              error: function(user, error) {
                console.log("Didn't save. Error is " + error);
              }
            })
            
            $("#userinfo").html(
                '<img src=' + user.attributes.profilepic + '/>' + '<br />' +
                'Name: ' + user.attributes.name + '<br />' +
                'Username: ' + user.attributes.username + '<br />' +
                'Email: ' + user.attributes.email + '<br />' +
                'Location: ' + user.attributes.location
            );

        });

        $("#connect").text("Yay, you're signed in.");
        $("#signout, #userinfo").show();

      } else if (user) {
        $("#logout").show();
        $('#username, #password, #note, #mainlogin h1').hide();
      } else {
        $("#connect").text("Connect with Facebook");
        $("#signout, #userinfo").hide();
      }
    }
  
    function fbSignIn() {
        // Make a new Parse user, 'sign in' with FB, and set their info in the Parse.user object.
        var user = new Parse.User();
        Parse.FacebookUtils.logIn('email, user_location', {
    			success: function(user) {
            userInfo();
          },
          error: function(user, error) {
            alert(error);
    			}
	    });
    }

    function fbSignOut() {
      Parse.User.logOut();
      $("#logout").hide();
    }

    function parseSignIn() {
      var username = $('#username').val(),
          password = $('#password').val();

      Parse.User.logIn(username, password, {
        success: function(user) {
          $("#logout").show();
          $('#username, #password, #note, #mainlogin h1').hide();
        },
        error: function(user, error) {
          alert(error.message);
        }
      });
    }

    function parseSignOut() {
      Parse.User.logOut();
      $("#logout").hide();
      $('#username, #password, #note, #mainlogin h1').show();
    }

    function resetPassword(email) {
      Parse.User.requestPasswordReset(email, {
        success: function() {
          alert("Check your email to reset your password.");
          $('#username, #password, #note, #mainlogin h1').show();
          $('#resetform').hide(); 
        },
        error: function(error) {
          // Show the error message somewhere
          alert("Error: " + error.code + " " + error.message);
        }
      });
    }
    
    userInfo();

    //Event Handlers
    $("#connect").click(function() {
        fbSignIn();
    });

    $("#signout").click(function() {
      fbSignOut();
      userInfo();
    });

    $("#mainlogin button").click(function (e) {
      parseSignIn();
      e.preventDefault();
    });

    $("#logout").click(function() {
      parseSignOut();
    });

    $("#note").click(function () {
      $(this).hide();
      $("#username, #password, #note").hide();
      $("#resetform").show();
    });

    $("#passwordreset").click(function () {
      var email = $("#resetform input").val();
      resetPassword(email);
    });

  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "http://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  </script>

</body>

</html>
